<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaThink - Pneumonia AI Detection</title>
    <meta name="description" content="Advanced AI-powered pneumonia detection using chest X-ray analysis">
    <style>
        :root {
            --background: hsl(210, 40%, 98%);
            --foreground: hsl(220, 15%, 20%);
            --card: hsl(0, 0%, 100%);
            --card-foreground: hsl(220, 15%, 20%);
            --primary: hsl(200, 90%, 55%);
            --primary-foreground: hsl(0, 0%, 100%);
            --primary-glow: hsl(200, 90%, 70%);
            --secondary: hsl(210, 30%, 96%);
            --muted: hsl(210, 25%, 95%);
            --muted-foreground: hsl(220, 10%, 45%);
            --accent: hsl(160, 60%, 45%);
            --destructive: hsl(0, 85%, 60%);
            --destructive-foreground: hsl(0, 0%, 100%);
            --border: hsl(210, 20%, 90%);
            --input: hsl(210, 25%, 94%);
            --ring: hsl(200, 90%, 55%);
            --success: hsl(160, 60%, 45%);
            --success-foreground: hsl(0, 0%, 100%);
            --radius: 0.5rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: var(--background); color: var(--foreground); line-height: 1.5; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 320px; background-color: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 2px 8px -2px hsla(200, 90%, 55%, 0.1); }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .brand-icon { padding: 8px; background: linear-gradient(135deg, var(--primary), var(--primary-glow)); border-radius: var(--radius); color: var(--primary-foreground); display: flex; align-items: center; justify-content: center; }
        .brand-text h1 { font-size: 20px; font-weight: 700; color: var(--foreground); }
        .brand-text p { font-size: 14px; color: var(--muted-foreground); }
        .new-patient-btn { width: 100%; padding: 12px 16px; background: linear-gradient(135deg, var(--primary), var(--primary-glow)); color: var(--primary-foreground); border: none; border-radius: var(--radius); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; transition: all 0.2s; }
        .new-patient-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px -4px hsla(200, 90%, 55%, 0.25); }
        .search-container { position: relative; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted-foreground); }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; background-color: var(--input); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; color: var(--foreground); }
        .search-input:focus { outline: none; border-color: var(--ring); box-shadow: 0 0 0 2px hsla(200, 90%, 55%, 0.2); }
        .patient-list { flex: 1; overflow-y: auto; padding: 16px; }
        .patient-list-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 14px; font-weight: 500; color: var(--muted-foreground); }
        .patient-card { padding: 12px; background-color: var(--card); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
        .patient-card:hover { background-color: var(--secondary); box-shadow: 0 4px 20px -4px hsla(200, 90%, 55%, 0.15); }
        .patient-card.selected { border-color: var(--primary); background-color: hsla(200, 90%, 55%, 0.05); box-shadow: 0 0 0 2px hsla(200, 90%, 55%, 0.2); }
        .patient-header { display: flex; align-items: center; justify-content: space-between; }
        .patient-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .patient-name { font-weight: 500; color: var(--card-foreground); }
        .patient-details { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted-foreground); }
        .patient-status { font-size: 12px; font-weight: 500; text-transform: capitalize; }
        .status-pneumonia { color: var(--destructive); }
        .status-normal { color: var(--success); }
        .status-analyzed { color: var(--primary); }
        .status-pending { color: var(--muted-foreground); }
        .auth-buttons { padding: 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .auth-btn { width: 100%; padding: 12px; border-radius: var(--radius); font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .auth-btn.outline { background-color: transparent; border: 1px solid var(--border); color: var(--foreground); }
        .auth-btn.outline:hover { background-color: var(--secondary); }
        .auth-btn.ghost { background-color: transparent; border: none; color: var(--foreground); }
        .auth-btn.ghost:hover { background-color: var(--secondary); }
        .main-content { flex: 1; overflow-y: auto; padding: 32px; }
        .content-section { max-width: 800px; margin: 0 auto; }
        .hidden { display: none; }
        .form-container { display: flex; flex-direction: column; gap: 24px; }
        .card-header h3 { font-size: 18px; font-weight: 600; color: var(--card-foreground); }
        .card-header svg { color: var(--primary); }
        .card-content { padding: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500; color: var(--foreground); }
        .form-group label svg { color: var(--muted-foreground); }
        .form-input, .form-select { padding: 12px; background-color: var(--input); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; color: var(--foreground); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--ring); box-shadow: 0 0 0 2px hsla(200, 90%, 55%, 0.2); }
        .upload-area { border: 2px dashed var(--border); border-radius: var(--radius); padding: 32px; text-align: center; transition: all 0.2s; position: relative; }
        .upload-area.drag-over { border-color: var(--primary); background-color: hsla(200, 90%, 55%, 0.05); }
        .upload-area.has-file { border-color: var(--success); background-color: hsla(160, 60%, 45%, 0.05); }
        .upload-content { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .upload-icon { width: 64px; height: 64px; background-color: hsla(200, 90%, 55%, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); }
        .upload-area.has-file .upload-icon { background-color: hsla(160, 60%, 45%, 0.1); color: var(--success); }
        .upload-title { font-weight: 500; color: var(--foreground); }
        .upload-subtitle { font-size: 14px; color: var(--muted-foreground); }
        .upload-info { font-size: 12px; color: var(--muted-foreground); }
        .file-input { display: none; }
        .browse-btn { margin-top: 16px; padding: 8px 16px; background-color: transparent; border: 1px solid var(--border); border-radius: var(--radius); color: var(--foreground); cursor: pointer; transition: all 0.2s; }
        .browse-btn:hover { background-color: var(--secondary); }
        .submit-container { display: flex; justify-content: center; }
        .analyze-btn { padding: 12px 32px; background: linear-gradient(135deg, var(--primary), var(--primary-glow)); color: var(--primary-foreground); border: none; border-radius: var(--radius); font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .analyze-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 30px -8px hsla(200, 90%, 55%, 0.3); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .results-container { display: flex; flex-direction: column; gap: 24px; }
        .prediction-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .prediction-header h2 { font-size: 24px; font-weight: 700; color: var(--foreground); }
        .prediction-badge { padding: 8px 16px; border-radius: 9999px; font-size: 14px; font-weight: 500; }
        .prediction-badge.pneumonia { background-color: var(--destructive); color: var(--destructive-foreground); }
        .prediction-badge.normal { background-color: var(--success); color: var(--success-foreground); }
        .prediction-content { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .xray-display { position: relative; border-radius: var(--radius); overflow: hidden; background-color: var(--muted); }
        .xray-img { width: 100%; height: auto; display: block; }
        .xray-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .prediction-details h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--foreground); }
        .prediction-details p { color: var(--muted-foreground); margin-bottom: 16px; }
        .confidence-score { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--foreground); }
        .confidence-value { font-weight: 600; color: var(--primary); }
        .chat-card { display: none; } /* Chat card is hidden by default, shown after analysis */
        .guidance-content { white-space: pre-wrap; font-size: 14px; line-height: 1.6; }
        @media (max-width: 1024px) { .form-grid, .prediction-content { grid-template-columns: 1fr; } .sidebar { width: 280px; } }
        @media (max-width: 768px) { .app-container { flex-direction: column; } .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); } .main-content { padding: 16px; } .patient-list { max-height: 200px; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
             <div class="sidebar-header">
                <div class="brand">
                    <div class="brand-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
                    <div class="brand-text"><h1>NexaThink</h1><p>AI Medical Assistant</p></div>
                </div>
                <button class="new-patient-btn" onclick="startNewPatient()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Patient</button>
                <div class="search-container"><svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input type="text" placeholder="Search patient by name" class="search-input" id="patientSearch"></div>
            </div>
            <div class="patient-list">
                <div class="patient-list-header"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Previous Patients (<span id="patientCount">4</span>)</span></div>
                <div id="patientListContainer"></div>
            </div>
            <div class="auth-buttons"><button class="auth-btn outline">Login</button><button class="auth-btn ghost">Sign Up</button></div>
        </aside>

        <main class="main-content">
            <div id="patientForm" class="content-section">
                <div class="form-container">
                    <div class="card">
                        <div class="card-header"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><h3>Patient Information</h3></div>
                        <div class="card-content">
                            <div class="form-grid">
                                <div class="form-group"><label for="patientName"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Patient Name</label><input type="text" id="patientName" placeholder="Enter patient's full name" class="form-input"></div>
                                <div class="form-group"><label for="patientAge"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Age</label><input type="number" id="patientAge" placeholder="Enter age" class="form-input" min="0" max="150"></div>
                            </div>
                            <div class="form-group"><label for="patientGender">Gender</label><select id="patientGender" class="form-select"><option value="">Select gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><h3>Chest X-ray Upload</h3></div>
                        <div class="card-content">
                            <div class="upload-area" id="uploadArea"><div class="upload-content" id="uploadContent"><div class="upload-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div><div class="upload-text"><p class="upload-title">Upload front chest X-ray image</p><p class="upload-subtitle">Drag and drop your X-ray image here, or click to browse</p><p class="upload-info">Supported formats: JPG, PNG, DICOM • Max size: 10MB</p></div></div><input type="file" id="xrayInput" accept="image/*,.dcm" class="file-input"><button type="button" class="browse-btn">Browse Files</button></div>
                        </div>
                    </div>
                    <div class="submit-container"><button id="analyzeBtn" class="analyze-btn" disabled>Analyze X-ray</button></div>
                </div>
            </div>

            <div id="analysisResults" class="content-section hidden">
                <div class="results-container">
                    <div class="card prediction-card">
                         <div class="card-content">
                            <div class="prediction-header">
                                <h2 id="predictionTitle">Analysis Result</h2>
                                <div id="predictionBadge" class="prediction-badge"></div>
                            </div>
                            <div class="prediction-content">
                                <div class="xray-display">
                                    <img id="xrayImage" src="" alt="X-ray Analysis" class="xray-img">
                                    <canvas id="xrayOverlay" class="xray-overlay"></canvas>
                                </div>
                                <div class="prediction-details">
                                    <h3>Explainable AI Analysis</h3>
                                    <p id="predictionDescription">AI-Detected Anomalies highlighted in the image above</p>
                                    <div class="confidence-score">
                                        <span>Confidence Score: </span>
                                        <span id="confidenceValue" class="confidence-value"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- This card will be used for the Gemini guidance -->
                    <div class="card">
                        <div class="card-header">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <h3>AI Health Guidance</h3>
                        </div>
                        <div class="card-content">
                            <p id="guidanceContent" class="guidance-content"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- INTEGRATED SCRIPT ---

        // --- Mock Data and Placeholder Functions (Preserved) ---
        const mockPatients = [
            { id: "1", name: "John Smith", age: 45, lastVisit: "2025-08-05", status: "pneumonia" },
            { id: "2", name: "Mary Johnson", age: 32, lastVisit: "2025-08-04", status: "normal" },
            { id: "3", name: "Robert Brown", age: 67, lastVisit: "2025-08-03", status: "analyzed" },
            { id: "4", name: "Sarah Davis", age: 28, lastVisit: "2025-08-02", status: "pending" }
        ];
        let currentPatient = null;
        
        // --- DOM Elements for Analysis ---
        const patientForm = document.getElementById('patientForm');
        const analysisResults = document.getElementById('analysisResults');
        const uploadArea = document.getElementById('uploadArea');
        const uploadContent = document.getElementById('uploadContent');
        const xrayInput = document.getElementById('xrayInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const xrayImage = document.getElementById('xrayImage');
        const xrayOverlay = document.getElementById('xrayOverlay');
        const ctx = xrayOverlay.getContext('2d');
        
        let uploadedFile = null;
        let analysisResultData = null;

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPatientList();
            setupEventListeners();
        });

        function setupEventListeners() {
            // File upload listeners
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
            uploadArea.addEventListener('drop', handleDrop);
            xrayInput.addEventListener('change', handleFileSelect);
            document.querySelector('.browse-btn').addEventListener('click', () => xrayInput.click());

            // Form validation listeners
            ['patientName', 'patientAge', 'patientGender'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateAnalyzeButton);
            });
            
            // Search listener
            document.getElementById('patientSearch').addEventListener('input', handlePatientSearch);
            
            // Analyze button listener
            analyzeBtn.addEventListener('click', analyzeXray);
            
            // Redraw overlay on window resize
            window.addEventListener('resize', () => { if (analysisResultData) drawOverlay(analysisResultData.anomalies); });
        }

        // --- Patient List & Form Logic (Preserved) ---
        function renderPatientList(filteredPatients = mockPatients) {
            const container = document.getElementById('patientListContainer');
            document.getElementById('patientCount').textContent = filteredPatients.length;
            container.innerHTML = filteredPatients.map(patient => `
                <div class="patient-card ${currentPatient?.id === patient.id ? 'selected' : ''}" onclick="selectPatient('${patient.id}')">
                    <div class="patient-header">
                        <div style="flex: 1;"><div class="patient-name-row"><span class="patient-name">${patient.name}</span></div><div class="patient-details"><span>Age ${patient.age}</span><span>•</span><span>${patient.lastVisit}</span></div></div>
                        <div class="patient-status status-${patient.status}">${patient.status}</div>
                    </div>
                </div>`).join('');
        }

        function selectPatient(patientId) {
            currentPatient = mockPatients.find(p => p.id === patientId);
            renderPatientList();
            document.getElementById('patientName').value = currentPatient.name;
            document.getElementById('patientAge').value = currentPatient.age;
            alert("Patient selected. Please upload a new X-ray for analysis.");
            clearFileUpload();
            updateAnalyzeButton();
        }
        
        function startNewPatient() {
            currentPatient = null;
            document.getElementById('patientName').value = '';
            document.getElementById('patientAge').value = '';
            document.getElementById('patientGender').value = '';
            clearFileUpload();
            patientForm.classList.remove('hidden');
            analysisResults.classList.add('hidden');
            renderPatientList();
            updateAnalyzeButton();
        }

        function handlePatientSearch() {
            const query = document.getElementById('patientSearch').value.toLowerCase();
            const filtered = mockPatients.filter(p => p.name.toLowerCase().includes(query));
            renderPatientList(filtered);
        }

        // --- File Handling & Validation (Integrated) ---
        function handleDrop(e) { e.preventDefault(); uploadArea.classList.remove('drag-over'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); }
        function handleFileSelect(e) { if (e.target.files.length > 0) handleFile(e.target.files[0]); }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) { alert('Please upload a valid image file.'); return; }
            uploadedFile = file;
            uploadArea.classList.add('has-file');
            uploadContent.querySelector('.upload-title').textContent = 'File ready for analysis!';
            uploadContent.querySelector('.upload-subtitle').textContent = file.name;
            updateAnalyzeButton();
        }
        
        function clearFileUpload() {
            uploadedFile = null;
            xrayInput.value = '';
            uploadArea.classList.remove('has-file');
            uploadContent.querySelector('.upload-title').textContent = 'Upload front chest X-ray image';
            uploadContent.querySelector('.upload-subtitle').textContent = 'Drag and drop your X-ray image here, or click to browse';
        }

        function updateAnalyzeButton() {
            const isValid = document.getElementById('patientName').value && document.getElementById('patientAge').value && document.getElementById('patientGender').value && uploadedFile;
            analyzeBtn.disabled = !isValid;
        }

        // --- Backend Integration & Display Logic (REWRITTEN) ---
        async function analyzeXray() {
            if (!uploadedFile) { alert("Please upload an X-ray image first."); return; }
            
            analyzeBtn.innerHTML = `<svg class="loading" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Analyzing...`;
            analyzeBtn.style.display = 'flex';
            analyzeBtn.style.gap = '8px';
            analyzeBtn.disabled = true;

            const formData = new FormData();
            formData.append('image', uploadedFile);

            try {
                const response = await fetch('http://127.0.0.1:5000/predict', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.statusText}`);
                }
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                console.error('Error during analysis:', error);
                alert('Analysis failed: ' + error.message);
                resetAnalysisUI();
            }
        }

        function resetAnalysisUI() {
            analyzeBtn.innerHTML = 'Analyze X-ray';
            analyzeBtn.disabled = false;
        }

        function displayResults(data) {
            analysisResultData = data;
            patientForm.classList.add('hidden');
            analysisResults.classList.remove('hidden');

            const predictionTitle = document.getElementById('predictionTitle');
            const predictionBadge = document.getElementById('predictionBadge');
            if (data.prediction === 'Pneumonia Detected') {
                predictionTitle.textContent = 'Pneumonia Detected';
                predictionBadge.textContent = 'PNEUMONIA';
                predictionBadge.className = 'prediction-badge pneumonia';
            } else {
                predictionTitle.textContent = 'Normal';
                predictionBadge.textContent = 'NORMAL';
                predictionBadge.className = 'prediction-badge normal';
            }

            document.getElementById('confidenceValue').textContent = `${(data.confidence * 100).toFixed(0)}%`;
            document.getElementById('guidanceContent').textContent = data.guidance;

            const reader = new FileReader();
            reader.onload = (e) => {
                xrayImage.src = e.target.result;
                xrayImage.onload = () => drawOverlay(data.anomalies);
            };
            reader.readAsDataURL(uploadedFile);
        }

        function drawOverlay(anomalies) {
            xrayOverlay.width = xrayImage.clientWidth;
            xrayOverlay.height = xrayImage.clientHeight;
            ctx.clearRect(0, 0, xrayOverlay.width, xrayOverlay.height);
            if (!anomalies || anomalies.length === 0) return;
            ctx.fillStyle = 'rgba(239, 68, 68, 0.4)';
            anomalies.forEach(anomaly => {
                const x = anomaly.x * xrayOverlay.width;
                const y = anomaly.y * xrayOverlay.height;
                const radius = anomaly.r * Math.min(xrayOverlay.width, xrayOverlay.height);
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
    </script>
</body>
</html>
